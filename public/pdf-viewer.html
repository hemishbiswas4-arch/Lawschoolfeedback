<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PDF Viewer</title>
    <link rel="stylesheet" href="/pdfjs/web/pdf_viewer.css" />

    <style>
      /* 1. Global Reset */
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #e1e1e1;
      }

      #viewerContainer {
        position: absolute;
        inset: 0;
        overflow: auto;
      }

      /* 2. LAYERS CONTROL */
      
      /* The Page Container */
      .page {
        position: relative;
      }

      /* The Text Layer (Invisible text for selection) */
      .textLayer {
        opacity: 0.1; /* Invisible but selectable */
        z-index: 2;
        mix-blend-mode: multiply;
      }

      /* THE NEW HIGHLIGHT LAYER */
      /* This sits exactly where the textLayer sits, but is visible */
      .custom-highlight-layer {
        position: absolute;
        inset: 0; /* Matches parent dimensions exactly */
        pointer-events: none; /* Let clicks pass through to textLayer */
        z-index: 1; /* Below text selection, above canvas */
      }

      /* 3. Highlight Styling */
      .highlight-rect {
        position: absolute;
        background: rgba(255, 226, 0, 0.4); 
        mix-blend-mode: multiply;
        border-bottom: 2px solid rgba(255, 200, 0, 0.8);
        z-index: 10;
      }
    </style>
  </head>

  <body>
    <div id="viewerContainer">
      <div id="viewer" class="pdfViewer"></div>
    </div>

    <script type="module">
      import * as pdfjsLib from "/pdfjs/build/pdf.mjs"
      import { PDFViewer, EventBus } from "/pdfjs/web/pdf_viewer.mjs"

      pdfjsLib.GlobalWorkerOptions.workerSrc = "/pdfjs/build/pdf.worker.mjs"

      /* --- Init --- */
      const params = new URLSearchParams(window.location.search)
      const fileUrl = params.get("file")
      if (!fileUrl) throw new Error("No PDF file specified")

      const eventBus = new EventBus()
      const viewerContainer = document.getElementById("viewerContainer")

      const viewer = new PDFViewer({
        container: viewerContainer,
        viewer: document.getElementById("viewer"),
        eventBus,
        textLayerMode: 2, 
      })

      const pdf = await pdfjsLib.getDocument(fileUrl).promise
      viewer.setDocument(pdf)


      /* ================= 1. Drawing Logic ================= */
      
      function clearPageHighlights(pageNumber) {
        const pageView = viewer.getPageView(pageNumber - 1);
        if (!pageView || !pageView.div) return;
        
        // Clear from our custom layer
        const layer = pageView.div.querySelector('.custom-highlight-layer');
        if (layer) layer.innerHTML = '';
      }

      function clearAllHighlights() {
        document.querySelectorAll('.custom-highlight-layer').forEach(el => el.innerHTML = '');
      }

      function drawRectsOnPage(pageNumber, rects) {
        const pageView = viewer.getPageView(pageNumber - 1);
        if (!pageView || !pageView.div) return;

        // 1. CREATE/FIND THE HIGHLIGHT LAYER
        // We append to a sibling of textLayer, not textLayer itself (to avoid opacity inheritance)
        let highlightLayer = pageView.div.querySelector('.custom-highlight-layer');
        
        if (!highlightLayer) {
            highlightLayer = document.createElement('div');
            highlightLayer.className = 'custom-highlight-layer';
            // Insert it before the textLayer so text selection still works on top
            const textLayer = pageView.div.querySelector('.textLayer');
            if (textLayer) {
                pageView.div.insertBefore(highlightLayer, textLayer);
            } else {
                pageView.div.appendChild(highlightLayer);
            }
        }

        // 2. DRAW
        rects.forEach(r => {
          const d = document.createElement("div")
          d.className = "highlight-rect"
          
          // Use Percentage Coordinates (Prevents Drift)
          d.style.left   = `${r.left * 100}%`
          d.style.top    = `${r.top * 100}%`
          d.style.width  = `${r.width * 100}%`
          d.style.height = `${r.height * 100}%`
          
          highlightLayer.appendChild(d)
        })
      }


      /* ================= 2. Selection Capture ================= */

      document.addEventListener("selectionchange", () => {
        const sel = window.getSelection()
        if (!sel || sel.isCollapsed) return

        const range = sel.getRangeAt(0)
        
        // 1. Ensure selection is inside the text layer
        const textLayer = range.commonAncestorContainer.nodeType === 1 
          ? range.commonAncestorContainer.closest('.textLayer')
          : range.commonAncestorContainer.parentElement?.closest('.textLayer');

        if (!textLayer) return; 

        // 2. Identify the Page
        const pageEl = textLayer.closest('.page');
        if (!pageEl) return;
        const pageNumber = parseInt(pageEl.getAttribute('data-page-number'));

        // 3. Measure relative to Text Layer (Crucial for Drift Fix)
        const layerRect = textLayer.getBoundingClientRect();
        const clientRects = Array.from(range.getClientRects());

        const normalizedRects = clientRects.map(r => ({
          left:   (r.left - layerRect.left) / layerRect.width,
          top:    (r.top  - layerRect.top)  / layerRect.height,
          width:  r.width / layerRect.width,
          height: r.height / layerRect.height
        }));

        if (normalizedRects.length === 0) return;

        window.parent.postMessage(
          {
            type: "PDF_SELECTION",
            payload: {
              text: sel.toString(),
              page: pageNumber,
              rects: normalizedRects,
            },
          },
          "*"
        )
      })


      /* ================= 3. Message Handling ================= */

      window.addEventListener("message", e => {
        const { type, payload } = e.data || {}
        
        switch (type) {
          case "PREVIEW_HIGHLIGHT":
            if (payload?.page && payload?.rects) {
                clearPageHighlights(payload.page); 
                drawRectsOnPage(payload.page, payload.rects)
            }
            break

          case "SET_COMMENT_HIGHLIGHTS":
             if (payload?.page && payload?.rects) {
                 clearPageHighlights(payload.page);
                 drawRectsOnPage(payload.page, payload.rects);
             }
             break

          case "CLEAR_ALL_HIGHLIGHTS":
            clearAllHighlights()
            break
        }
      })
    </script>
  </body>
</html>